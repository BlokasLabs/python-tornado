From a9c94f322e691d48151c1eb67f2742a39ad3ab46 Mon Sep 17 00:00:00 2001
From: Ben Darnell <ben@bendarnell.com>
Date: Thu, 23 May 2013 23:57:30 -0400
Subject: [PATCH] Backport changes from ssl.match_hostname in Python 3.3.
Origin: upstream, https://github.com/facebook/tornado/commit/a9c94f322e691d48151c1eb67f2742a39ad3ab46
Bug: https://github.com/facebook/tornado/issues/799
Debian-Bug: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=709069

* Fix potential CPU DoS via abusive wildcard pattern
  http://hg.python.org/cpython/rev/fafd33db6ff6

---

--- python-tornado-2.4.1.orig/tornado/simple_httpclient.py
+++ python-tornado-2.4.1/tornado/simple_httpclient.py
@@ -486,9 +486,16 @@ class CertificateError(ValueError):
     pass
 
 
-def _dnsname_to_pat(dn):
+def _dnsname_to_pat(dn, max_wildcards=1):
     pats = []
     for frag in dn.split(r'.'):
+        if frag.count('*') > max_wildcards:
+            # Issue #17980: avoid denials of service by refusing more
+            # than one wildcard per fragment.  A survery of established
+            # policy among SSL implementations showed it to be a
+            # reasonable choice.
+            raise CertificateError(
+                "too many wildcards in certificate DNS name: " + repr(dn))
         if frag == '*':
             # When '*' is a fragment by itself, it matches a non-empty dotless
             # fragment.
